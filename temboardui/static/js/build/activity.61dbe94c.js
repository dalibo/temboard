(window.webpackJsonp=window.webpackJsonp||[]).push([["activity"],{"./temboardui/plugins/activity/static/js/temboard.activity.js":function(t,e,a){"use strict";a.r(e);var n=a("./node_modules/datatables.net-bs4/js/dataTables.bootstrap4.js"),o=a.n(n);a("./node_modules/datatables.net-bs4/css/dataTables.bootstrap4.css");o()(window,$),$(function(){var t,e=null,a=2,n=!1;$("#intervalDuration").html(a);var o=$("#tableActivity");function i(t,e){"Y"==e&&$(t).addClass("text-danger font-weight-bold")}var s="Select to terminate",l="Disable auto-refresh and select to terminate",d=[{orderable:!1,className:"text-center",data:function(t,e,a,o){var i=n?"disabled":"",r=i?l:s,d='<input type="checkbox" '+i+' class="input-xs" data-pid="'+t.pid+'"';return d+='title="'+r+'"',d+=" />"}},{title:"PID",data:"pid",className:"text-right",orderable:!1},{title:"Database",data:"database",orderable:!1},{title:"User",data:"user",orderable:!1},{title:"CPU",data:"cpu",className:"text-right"},{title:"mem",data:"memory",className:"text-right"},{title:"Read/s",data:function(t){return t.read_s.human2bytes()},render:function(t,e,a){return"display"==e?a.read_s:t},className:"text-right"},{title:"Write/s",data:function(t){return t.write_s.human2bytes()},render:function(t,e,a){return"display"==e?a.write_s:t},className:"text-right"},{title:"IOW",data:"iow",className:"text-center",createdCell:i}];d="running"==activityMode?d.concat([{title:"W",data:"wait",className:"text-center",createdCell:i}]):d.concat([{title:"Lock Rel.",data:"relation",className:"text-right",orderable:!1},{title:"Lock Mode",data:"mode",orderable:!1},{title:"Lock Type",data:"type",orderable:!1}]);d=d.concat([{title:"State",data:function(t,e,a,n){return t.state&&t.state.trunc(12)},className:"text-center",createdCell:function(t,e,a,n,o){var i="";switch(a.state){case"active":i="text-success font-weight-bold";break;case"idle in transaction":case"idle in transaction (aborted)":i="text-danger font-weight-bold"}$(t).addClass(i),a.state.length>12&&$(t).attr("title",a.state)}},{title:"Time",className:"text-right",data:"duration",render:function(t,e,a){return"display"===e?t+" s":t}},{title:"Query",className:"query",data:function(t,e,a,n){return'<pre><code class="sql">'+t.query+"</code></pre>"},createdCell:function(t,e){$(t).attr("data-toggle","popover").attr("data-trigger","hover"),$(t).mouseover(function(){var t=$("<span>",{class:"copy position-absolute right-0 pr-1 pl-1 bg-secondary text-white rounded",html:"Click to copy"});$(this).prepend(t)}),$(t).mouseout(function(){$(this).find(".copy").remove()})}}]);var c=o.DataTable({paging:!1,stateSave:!0,lengthChange:!1,autoWidth:!1,order:[[d.length-2,"desc"]],columns:d,dom:"t"});function u(){var o=new Date,i="running"!=activityMode?"/"+activityMode:"";e=$.ajax({url:"/proxy/"+agent_address+"/"+agent_port+"/activity"+i,type:"GET",beforeSend:function(t){$("#loadingIndicator").removeClass("d-none"),n=!0},async:!0,contentType:"application/json",success:function(t){$("#ErrorModal").modal("hide"),function(t){$("[data-toggle=popover]").popover("hide"),c.clear(),c.rows.add(t[activityMode].rows).draw(),$("pre code").each(function(t,e){hljs.highlightBlock(e)}),$('[data-toggle="popover"]').popover({html:!0,content:function(){return $(this).find("pre").html()},template:'<div class="popover sql" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>'}),$("#waiting-count").html(t.waiting.rows.length||"&nbsp;").toggleClass("badge-warning",t.waiting.rows.length>0).toggleClass("badge-light",!t.waiting.rows.length>0),$("#blocking-count").html(t.blocking.rows.length||"&nbsp;").toggleClass("badge-warning",t.blocking.rows.length>0).toggleClass("badge-light",!t.blocking.rows.length>0)}(t)},error:function(t,e){if("abort"!=e){var a=t.status,n="Internal error.";a>0?n=r(JSON.parse(t.responseText).error):a="",$("#ErrorModal").modal("hide"),$("#modalError").html(function(t,e){var a="";return a+='<div class="modal" id="ErrorModal" tabindex="-1" role="dialog" aria-labelledby="ErrorModalLabel" aria-hidden="true">',a+='   <div class="modal-dialog">',a+='     <div class="modal-content">',a+='       <div class="modal-header">',a+='         <h4 class="modal-title" id="ErrorModalLabel">Error '+t+"</h4>",a+='         <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>',a+="       </div>",a+='       <div class="modal-body">',a+='         <div class="alert alert-danger" role="alert">'+e+"</div>",a+="       </div>",a+='       <div class="modal-footer" id="ErrorModalFooter">',a+='         <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>',a+="       </div>",a+="     </div>",a+="   </div>",a+="</div>"}(a,n)),$("#ErrorModal").modal("show")}},complete:function(e,i){$("#loadingIndicator").addClass("d-none"),n=!1;var r=1e3*a-(new Date-o);t=window.setTimeout(u,r)}})}function p(){$("#killButton").addClass("disabled"),$("#autoRefreshPausedMsg").addClass("d-none"),$("#tableActivity input:checked").each(function(){$(this).attr("checked",!1)}),$("#tableActivity input[type=checkbox]").each(function(){$(this).attr("disabled",!0),$(this).attr("title",l)}),u()}p(),$(document.body).on("click","input[type=checkbox]",function(){$("#killButton").toggleClass("disabled",0===$("#tableActivity input:checked").length)}),$("#killButton").click(function(){if(function(t){if(!xsession)return g(),t&&t.stopPropagation(),!1;return!0}()){var t=[];if($("#tableActivity input:checked").each(function(){t.push($(this).data("pid"))}),0!==t.length){$("#Modal").modal("show"),$("#ModalLabel").html("Terminate backend");for(var e="",a=0;a<t.length;a++)e+='<span class="badge badge-primary">'+t[a]+"</span> ";$("#ModalInfo").html(e);'<button type="button" id="submitKill" class="btn btn-danger">Yes, terminate</button>',' <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>',$("#ModalFooter").html('<button type="button" id="submitKill" class="btn btn-danger">Yes, terminate</button> <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>'),$("#submitKill").click(function(){$.ajax({url:"/proxy/"+agent_address+"/"+agent_port+"/activity/kill",type:"POST",beforeSend:function(t){t.setRequestHeader("X-Session",xsession),$("#ModalInfo").html('<div class="row"><div class="col-4 offset-4"><div class="progress"><div class="progress-bar progress-bar-striped" style="width: 100%;">Please wait ...</div></div></div></div>')},async:!0,contentType:"application/json",dataType:"json",data:JSON.stringify({pids:t}),success:function(t){$("#Modal").modal("hide");var e=window.location.href;window.location.replace(e)},error:function(t){401==t.status?g():($("#ModalInfo").html('<div class="row"><div class="col-12"><div class="alert alert-danger" role="alert">Error: '+r(JSON.parse(t.responseText).error)+"</div></div></div>"),$("#ModalFooter").html('<button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>'))}})})}}});var b=$("#state-filter input[type=checkbox]");b.change(c.draw),$.fn.dataTable.ext.search.push(function(t,e,a,n){var o=[];return b.each(function(t,e){var a=$(e);a.prop("checked")&&o.push(a.val())}),o.indexOf(n.state)>-1});var h=$("#searchFilter");function g(){if(confirm("You need to be logged in the instance agent to perform this action")){var t=$.param({redirect_to:window.location.href});window.location.href=agentLoginUrl+"?"+t}}h.keyup(c.draw),$.fn.dataTable.ext.search.push(function(t,e){for(var a=h.val(),n=0,o=e.length;n<o;n++)if(-1!=e[n].toUpperCase().indexOf(a.toUpperCase()))return!0;return!1}),$("#tableActivity").on("click",".sql",function(t){t.preventDefault();var e=document.createRange(),a=window.getSelection();e.selectNodeContents(this),a.removeAllRanges(),a.addRange(e),document.execCommand("copy"),$(this).parents("td").find(".copy").html("Copied to clipboard")}),$("#tableActivity").on("mouseenter",function(a){$("#autoRefreshPausedMsg").removeClass("d-none"),e&&e.abort(),window.clearTimeout(t),$("#tableActivity input[type=checkbox]").each(function(){$(this).attr("disabled",!1),$(this).attr("title",s)})}),$("#tableActivity").on("mouseleave",function(t){0==$("#tableActivity input:checked").size()&&p()}),$("#resumeAutoRefresh").on("click",function(t){p(),t.preventDefault()})});var i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function r(t){return String(t).replace(/[&<>"'\/]/g,function(t){return i[t]})}String.prototype.trunc=String.prototype.trunc||function(t){return this.length>t?this.substr(0,t-1)+"&hellip;":this},String.prototype.human2bytes=String.prototype.human2bytes||function(){var t=parseFloat(this);if("number"==typeof t){var e=this.slice(-1);return t*Math.pow(2,10*["B","K","M","G","T","P","E","Z","Y"].indexOf(e))}return this}}},[["./temboardui/plugins/activity/static/js/temboard.activity.js","runtime","vendors~activity~notifications~settings.group~settings.instance~settings.user"]]]);
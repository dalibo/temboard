{% autoescape None %}
{% extends ../../../templates/base.html %}

{% block title %}temBoard / {{instance}} / Activity / {% if mode == 'waiting' %}Waiting{% elif mode == 'blocking' %}Blocking{% elif mode == 'running' %}Running{% end %} queries{% end %}

{% block head %}
{% for link in vitejs.css_links_for('activity.js') %}{% raw link %}{% end %}
{% end %}

{% block content %}
<div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="ModalLabel"></h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body" id="ModalInfo">
      </div>
      <div class="modal-body" id="ModalBody">
      </div>
      <div class="modal-footer" id="ModalFooter">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div id="app">
  <!-- Mode Tabs -->
  <ul class="nav nav-tabs">
    <li class="{{'active' if mode == 'running' else ''}} nav-item">
      <a href="/server/{{instance.agent_address}}/{{instance.agent_port}}/activity/running" class="nav-link running"> Running</a>
    </li>
    <li class="{{'active' if mode == 'waiting' else ''}} nav-item">
      <a href="/server/{{instance.agent_address}}/{{instance.agent_port}}/activity/waiting" class="nav-link waiting"> Waiting
        <div id="waiting-count" class="badge" :class="waitingCount > 0 ? 'badge-warning' : 'badge-light'" style="min-width: 2em;">{{! waitingCount || '&nbsp;' }}</div>
      </a>
    </li>
    <li class="{{'active' if mode == 'blocking' else ''}} nav-item">
      <a href="/server/{{instance.agent_address}}/{{instance.agent_port}}/activity/blocking" class="nav-link blocking">Blocking
        <div id="blocking-count" class="badge" :class="blockingCount > 0 ? 'badge-warning' : 'badge-light'" style="min-width: 2em;">{{! blockingCount || '&nbsp;' }}</div>
      </a>
    </li>
  </ul>
  <div class="row d-flex justify-content-between">
    <div class="col-auto">
      <span class="d-inline-block" data-toggle="tooltip" title="Terminate the backends selected below">
        <button id="killButton" type="button" class="btn btn-danger" :class="{'disabled': !freezed}" @click="terminate(selectedPids)">Terminate</button>
      </span>
    </div>
    <div class="col-auto align-self-center">
      <span id="autoRefreshResume" class="d-text-muted" :class="{'d-none': !freezed}">
        <a class="btn btn-secondary" role="button" href @click.prevent="resume"><i class="fa fa-play"></i> resume auto refresh</a>
      </span>
      <span class="text-muted" :class="{'d-none': freezed}">
        <img src="/images/ring-alt.svg" width="24" class="fa-fw" :class="{'d-none': !loading}">
        Auto refresh
        <span :class="{'d-none': paused}">2s</span>
        <span :class="{'d-none': !paused}">paused</span>
      </span>
    </div>
    <div class="col-auto">
      <a class="btn collapse-toggle dropdown-toggle collapsed" data-toggle="collapse" href="#filters" role="button" aria-expanded="false" aria-controls="filters">
        filters
      </a>
    </div>
  </div>
  <!-- Filters drop down -->
  <div class="row">
    <div class="col-12 collapse" id="filters">
      <div class="justify-content-end d-flex">
        <div class="form-group mb-1">
          <input type="text" placeholder="Search" class="form-control" v-model="filter">
        </div>
      </div>
      <form id="state-filter" class="form-inline justify-content-end d-flex">
        <div class="form-group pr-1">
          <label><strong>States:</strong></label>
        </div>

        <div class="form-check form-check-inline" v-for="state in states">
          <input class="form-check-input" type="checkbox" :id="`state-filter-${state}`" :value="state" checked v-model="selectedStates">
          <label class="form-check-label" :for="`state-filter-${state}`">{{! state }}</label>
        </div>
      </form>
    </div>
  </div>
  <!-- Sessions table -->
  <div class="row">
    <div class="col-12">
      <b-table
        striped
        small
        :items="sessions"
        :fields="fields"
        class="table-query mt-1 small"
        @row-hovered="pause"
        @row-unhovered="!freezed && resume()"
        filter="null"
        :filter-function="doFilter"
        sort-by="duration"
        sort-desc
        >
        <template v-slot:cell()="data">
          <span v-html="data.value" :class="{'text-danger font-weight-bold': data.value == 'Y'}"></span>
        </template>
        <template v-slot:cell(check)="row">
          <input type="checkbox" :disabled="!paused && !freezed" class="input-xs" v-model="selectedPids" :value="row.item.pid" title="Select to terminate" />
        </template>
        <template v-slot:cell(query)="data">
          <div class="position-relative" @click="copy(data.item.query)">
            <copy>
              <pre class="sql hljs" v-html="highlight(data.value)"></pre>
            </copy>
          </div>
        </template>
        <template v-slot:cell(state)="data">
          <span :title="data.value" v-html="truncateState(data.value)"></span>
        </template>
      </b-table>
      <p class="text-center text-muted">Showing 300 longest queries.</p>
    </div>
  </div>
</div>

<script type="module" src="{{ vitejs.url_for('activity.js') }}"></script>
<script>
var xsession = {{ json_encode(xsession) }};
var agent_address = "{{instance.agent_address}}";
var agent_port = "{{instance.agent_port}}";
var activityMode = "{{mode}}";
var agentLoginUrl = '/server/{{ instance.agent_address }}/{{ instance.agent_port }}/login';
</script>

{% end %}
